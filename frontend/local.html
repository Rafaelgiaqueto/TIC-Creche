<!DOCTYPE html>
<html>
  <head>
    <title>Controle de Patrimônio</title>
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
    />
  </head>
  <body>
    <div class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-md-8">
          <h3>Cadastro de Local de Patrimônio</h3>
          <form id="localPatrimonioForm">
            <div class="form-group">
              <label for="nome_local">Nome do Local:</label>
              <input
                type="text"
                class="form-control"
                id="nome_local"
                required
              />
            </div>
            <div class="form-group">
              <label for="descricao">Descrição:</label>
              <input type="text" class="form-control" id="descricao" required />
            </div>
            <button type="submit" class="btn btn-primary" id="salvarButton">
              Cadastrar
            </button>
            <button type="button" class="btn btn-secondary" id="cancelarButton">
              Cancelar
            </button>
          </form>
        </div>
      </div>
      <div class="row mt-5 justify-content-center">
        <div class="col-md-12">
          <h3>Locais de Patrimônio Cadastrados</h3>
          <div class="table-responsive">
            <table class="table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nome</th>
                  <th>Descrição</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="localPatrimonioTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>

    <script>
      const API_URL = `${window.location.origin}/`;

      async function verificarNomeDuplicado(
        nome_local,
        id_local_patrimonio = null
      ) {
        const response = await fetch(
          API_URL + "local-patrimony?nome_local=" + nome_local
        );
        const locaisPatrimonio = await response.json();

        // Verifica se já existe um local de patrimônio com o mesmo nome, excluindo o atual em caso de edição
        if (id_local_patrimonio) {
          return locaisPatrimonio.some(
            (localPatrimonio) =>
              localPatrimonio.nome_local.toLowerCase() ===
                nome_local.toLowerCase() &&
              localPatrimonio.id_local_patrimonio !== id_local_patrimonio
          );
        } else {
          return locaisPatrimonio.some(
            (localPatrimonio) =>
              localPatrimonio.nome_local.toLowerCase() ===
              nome_local.toLowerCase()
          );
        }
      }

      async function cadastrarLocalPatrimonio(event) {
        event.preventDefault();

        const nome_local = document.getElementById("nome_local").value;
        const descricao = document.getElementById("descricao").value;

        const token = localStorage.getItem("token");

        // Verifica se o nome já está em uso, excluindo o atual em caso de edição
        const id_local_patrimonio = document
          .getElementById("salvarButton")
          .getAttribute("data-id");
        const nomeDuplicado = await verificarNomeDuplicado(
          nome_local,
          id_local_patrimonio
        );
        if (nomeDuplicado) {
          alert(
            "Erro ao cadastrar local de patrimônio: O nome já está em uso."
          );
          return; // Impede o cadastro
        }

        const localPatrimonio = {
          nome_local,
          descricao,
        };

        if (id_local_patrimonio) {
          // Modo de edição
          const response = await fetch(
            API_URL + `local-patrimony/${id_local_patrimonio}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(localPatrimonio),
            }
          );

          if (response.ok) {
            alert("Local de patrimônio atualizado com sucesso!");
            cancelarEdicao();
          } else {
            const error = await response.json();
            alert("Erro ao atualizar local de patrimônio: " + error.error);
          }
        } else {
          // Modo de cadastro
          const response = await fetch(API_URL + "local-patrimony", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(localPatrimonio),
          });

          if (response.ok) {
            alert("Local de patrimônio cadastrado com sucesso!");
          } else {
            const error = await response.json();
            alert("Erro ao cadastrar local de patrimônio: " + error.error);
          }
        }

        document.getElementById("nome_local").value = "";
        document.getElementById("descricao").value = "";
        cancelarEdicao();
        carregarLocaisPatrimonio();
      }

      async function carregarLocaisPatrimonio() {
        const response = await fetch(API_URL + "local-patrimony");
        const locaisPatrimonio = await response.json();

        const tableBody = document.getElementById("localPatrimonioTableBody");
        tableBody.innerHTML = "";

        locaisPatrimonio.forEach((localPatrimonio) => {
          const row = document.createElement("tr");
          row.innerHTML = `
          <td>${localPatrimonio.id_local_patrimonio}</td>
          <td>${localPatrimonio.nome_local}</td>
          <td>${localPatrimonio.descricao}</td>
          <td>
            <button type="button" class="btn btn-primary btn-editar" data-id="${localPatrimonio.id_local_patrimonio}">Editar</button>
            <button type="button" class="btn btn-danger btn-excluir" data-id="${localPatrimonio.id_local_patrimonio}">Excluir</button>
          </td>
        `;
          tableBody.appendChild(row);
        });

        const editarButtons = document.querySelectorAll(".btn-editar");
        const excluirButtons = document.querySelectorAll(".btn-excluir");

        editarButtons.forEach((button) => {
          button.addEventListener("click", editarLocalPatrimonio);
        });

        excluirButtons.forEach((button) => {
          button.addEventListener("click", excluirLocalPatrimonio);
        });
      }

      async function editarLocalPatrimonio(event) {
        const id_local_patrimonio = event.target.getAttribute("data-id");

        const response = await fetch(
          API_URL + `local-patrimony/${id_local_patrimonio}`
        );

        if (response.ok) {
          const localPatrimonio = await response.json();

          document.getElementById("nome_local").value =
            localPatrimonio.nome_local;
          document.getElementById("descricao").value =
            localPatrimonio.descricao;

          document
            .getElementById("salvarButton")
            .setAttribute("data-id", id_local_patrimonio);
          document.getElementById("salvarButton").textContent = "Atualizar";
        } else {
          const error = await response.json();
          alert(
            "Erro ao carregar informações do local de patrimônio: " +
              error.error
          );
        }
      }

      async function excluirLocalPatrimonio(event) {
        const id_local_patrimonio = event.target.getAttribute("data-id");

        const token = localStorage.getItem("token");

        const response = await fetch(
          API_URL + `local-patrimony/${id_local_patrimonio}`,
          {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          }
        );

        if (response.ok) {
          alert("Local de patrimônio excluído com sucesso!");
          carregarLocaisPatrimonio();
        } else {
          const error = await response.json();
          alert("Erro ao excluir local de patrimônio: " + error.error);
        }
      }

      function cancelarEdicao() {
        document.getElementById("nome_local").value = "";
        document.getElementById("descricao").value = "";

        document.getElementById("salvarButton").removeAttribute("data-id");
        document.getElementById("salvarButton").textContent = "Cadastrar";
      }

      document
        .getElementById("localPatrimonioForm")
        .addEventListener("submit", cadastrarLocalPatrimonio);
      document
        .getElementById("cancelarButton")
        .addEventListener("click", cancelarEdicao);

      carregarLocaisPatrimonio();
    </script>
  </body>
</html>
